<ion-header>
  <ion-toolbar>
    <ion-title>Profile</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="logout()">
        <ion-icon slot="icon-only" name="log-out"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="profile-header">
    <div class="profile-avatar">
      <ion-icon name="person-circle"></ion-icon>
    </div>
    <h2>{{ currentUser?.name }}</h2>
    <p>{{ currentUser?.email }}</p>
    
    <div *ngIf="isAdmin()" class="admin-badge">
      <ion-badge color="primary">Admin</ion-badge>
      <ion-button size="small" fill="clear" (click)="goToAdmin()">Go to Admin Panel</ion-button>
    </div>
  </div>
  
  <ion-segment [(ngModel)]="segment" (ionChange)="segmentChanged($event)">
    <ion-segment-button value="info">
      <ion-label>Profile</ion-label>
    </ion-segment-button>
    <ion-segment-button value="security">
      <ion-label>Security</ion-label>
    </ion-segment-button>
    <ion-segment-button value="adoptions">
      <ion-label>Adoptions</ion-label>
    </ion-segment-button>
  </ion-segment>
  
  <div [ngSwitch]="segment">
    <!-- Profile Info Tab -->
    <div *ngSwitchCase="'info'" class="form-container">
      <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
        <div class="form-group">
          <ion-item>
            <ion-label position="floating">Full Name</ion-label>
            <ion-input type="text" formControlName="name"></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched">
            <span *ngIf="profileForm.get('name')?.errors?.required">Name is required</span>
            <span *ngIf="profileForm.get('name')?.errors?.minlength">Name must be at least 3 characters</span>
          </div>
        </div>
        
        <div class="form-group">
          <ion-item>
            <ion-label position="floating">Phone (optional)</ion-label>
            <ion-input type="tel" formControlName="phone"></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched">
            <span *ngIf="profileForm.get('phone')?.errors?.pattern">Please enter a valid 10-digit phone number</span>
          </div>
        </div>
        
        <div class="form-group">
          <ion-item>
            <ion-label position="floating">Address (optional)</ion-label>
            <ion-textarea rows="3" formControlName="address"></ion-textarea>
          </ion-item>
        </div>
        
        <ion-button expand="block" type="submit" [disabled]="profileForm.invalid || !profileForm.dirty">
          Update Profile
        </ion-button>
      </form>
      
      <div class="info-section">
        <h3>Account Information</h3>
        <ion-list lines="full">
          <ion-item>
            <ion-label>
              <ion-text color="medium">Email</ion-text>
              <p>{{ currentUser?.email }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <ion-text color="medium">Member Since</ion-text>
              <p>{{ currentUser?.createdAt | date }}</p>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-label>
              <ion-text color="medium">Account Type</ion-text>
              <p>{{ currentUser?.role === 'admin' ? 'Administrator' : 'Regular User' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
    </div>
    
    <!-- Security Tab -->
    <div *ngSwitchCase="'security'" class="form-container">
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
        <div class="form-group">
          <ion-item>
            <ion-label position="floating">Current Password</ion-label>
            <ion-input type="password" formControlName="currentPassword"></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
            <span *ngIf="passwordForm.get('currentPassword')?.errors?.required">Current password is required</span>
            <span *ngIf="passwordForm.get('currentPassword')?.errors?.minlength">Password must be at least 6 characters</span>
          </div>
        </div>
        
        <div class="form-group">
          <ion-item>
            <ion-label position="floating">New Password</ion-label>
            <ion-input type="password" formControlName="newPassword"></ion-input>
          </ion-item>
          <div class="error-message" *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
            <span *ngIf="passwordForm.get('newPassword')?.errors?.required">New password is required</span>
            <span *ngIf="passwordForm.get('newPassword')?.errors?.minlength">Password must be at least 6 characters</span>
          </div>
        </div>
        
        <ion-button expand="block" type="submit" [disabled]="passwordForm.invalid">
          Change Password
        </ion-button>
      </form>
      
      <div class="security-info">
        <h3>Security Tips</h3>
        <ul>
          <li>Use a strong, unique password</li>
          <li>Include upper and lowercase letters, numbers, and symbols</li>
          <li>Never share your password with others</li>
          <li>Change your password periodically</li>
        </ul>
      </div>
    </div>
    
    <!-- Adoptions Tab -->
    <div *ngSwitchCase="'adoptions'">
      <div *ngIf="loading" class="loading-container">
        <ion-spinner name="dots"></ion-spinner>
        <p>Loading your adoption applications...</p>
      </div>
      
      <div *ngIf="!loading && applications.length === 0" class="empty-state">
        <ion-icon name="paw-outline"></ion-icon>
        <h3>No adoption applications</h3>
        <p>You haven't applied to adopt any pets yet</p>
        <ion-button routerLink="/tabs/pets" expand="block" fill="clear">
          Browse Pets for Adoption
        </ion-button>
      </div>
      
      <ion-list *ngIf="!loading && applications.length > 0">
        <ion-list-header>
          <ion-label>Your Adoption Applications</ion-label>
        </ion-list-header>
        
        <ion-item *ngFor="let application of applications" (click)="navigateToPetDetail(application.petId)" button>
          <ion-thumbnail slot="start" *ngIf="application.pet?.imageUrl">
            <img [src]="application.pet?.imageUrl" alt="{{ application.pet?.name }}">
          </ion-thumbnail>
          <ion-icon *ngIf="!application.pet?.imageUrl" slot="start" name="paw" size="large"></ion-icon>
          
          <ion-label>
            <h2>{{ application.pet?.name || 'Pet' }}</h2>
            <p>Applied on: {{ getFormattedDate(application.createdAt) }}</p>
            <p *ngIf="application.pet">
              {{ application.pet.breed || application.pet.species }}
              <span *ngIf="application.pet.age"> â€¢ {{ application.pet.age }} year(s) old</span>
            </p>
          </ion-label>
          
          <ion-badge slot="end" color="{{ getStatusColor(application.status) }}">
            {{ application.status | titlecase }}
          </ion-badge>
        </ion-item>
      </ion-list>
    </div>
  </div>
</ion-content>
